<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Server Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { /* your config */ };
    initializeApp(firebaseConfig);

    const auth = getAuth();
    const provider = new GoogleAuthProvider();
    const db = getFirestore();
    provider.setCustomParameters({ prompt: "select_account" });

    const signInBtn = document.getElementById("signInBtn"),
          signOutBtn = document.getElementById("signOutBtn"),
          forgotBtn = document.getElementById("forgotBtn"),
          appDiv = document.getElementById("app"),
          loginDiv = document.getElementById("login"),
          serversList = document.getElementById("serversList"),
          linkInput = document.getElementById("serverLink"),
          nameInput = document.getElementById("serverName"),
          pinInput = document.getElementById("pinInput"),
          addBtn = document.getElementById("addServerBtn");

    let currentUser = null, accountData = { pin: "", servers: [] };

    signInBtn.onclick = async () => {
      try { await signInWithPopup(auth, provider); } 
      catch { alert("Sign-in failed."); }
    };

    signOutBtn.onclick = async () => {
      await signOut(auth);
      location.reload();
    };

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        loginDiv.classList.add("hidden");
        appDiv.classList.remove("hidden");
        if (!localStorage.getItem("devicePin")) {
          const d = prompt("Set your 4-digit DEVICE PIN:");
          if (/^\d{4}$/.test(d)) localStorage.setItem("devicePin", d);
          else alert("Device PIN must be 4 digits.");
        }
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) accountData = snap.data(); else await setDoc(doc(db, "users", user.uid), accountData);
        renderServers();
      } else {
        loginDiv.classList.remove("hidden");
        appDiv.classList.add("hidden");
      }
    });

    async function saveAccount() {
      await setDoc(doc(db, "users", currentUser.uid), accountData);
    }

    function renderServers() {
      serversList.innerHTML = "";
      accountData.servers.forEach((srv, i) => {
        const div = document.createElement("div");
        div.className = "server-card";

        const title = document.createElement("div");
        title.className = "server-title";
        title.textContent = srv.name || srv.link;
        div.append(title);

        const buttons = document.createElement("div");
        buttons.className = "server-buttons";
        const edit = createBtn("Edit", () => editSrv(i), false);
        const del = createBtn("Delete", () => delSrv(i), true);
        buttons.append(edit, del);
        div.append(buttons);

        const link = document.createElement("a");
        link.href = srv.link;
        link.target = "_blank";
        link.rel = "noopener";
        link.textContent = "▶︎ Join";
        link.className = "join-link";
        div.append(link);
        serversList.append(div);
      });
    }

    function createBtn(txt, fn, isDelete) {
      const b = document.createElement("button");
      b.textContent = txt;
      b.className = isDelete ? "btn delete" : "btn";
      b.onclick = fn;
      return b;
    }

    addBtn.onclick = async () => {
      const link = linkInput.value.trim(),
            name = nameInput.value.trim(),
            pin = pinInput.value.trim();

      if (!link || !/^\d{4}$/.test(pin)) return alert("Enter link + 4-digit PIN");
      if (!accountData.pin) accountData.pin = pin;
      if (pin !== accountData.pin) return alert("Incorrect PIN");

      accountData.servers.push({ link, name: name || link });
      await saveAccount();
      renderServers();
      linkInput.value = nameInput.value = pinInput.value = "";
    };

    forgotBtn.onclick = async () => {
      const dp = localStorage.getItem("devicePin");
      if (!dp) return alert("Set device PIN first.");
      const entered = prompt("Enter your DEVICE PIN:");
      if (entered !== dp) return alert("Incorrect device PIN.");
      const np = prompt("Enter NEW 4-digit Account PIN:");
      if (!/^\d{4}$/.test(np)) return alert("Account PIN must be 4 digits.");
      accountData.pin = np;
      await saveAccount();
      alert("Your account PIN has been reset.");
    };

    async function editSrv(i) {
      const p = prompt("Enter Account PIN:");
      if (p !== accountData.pin) return alert("Incorrect PIN");
      const l = prompt("New link:", accountData.servers[i].link),
            n = prompt("New name:", accountData.servers[i].name);
      if (l && n) { accountData.servers[i] = { link: l, name: n }; await saveAccount(); renderServers(); }
    }

    async function delSrv(i) {
      const p = prompt("Enter Account PIN:");
      if (p !== accountData.pin) return alert("Incorrect PIN");
      accountData.servers.splice(i, 1);
      await saveAccount();
      renderServers();
    }
  </script>

  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin: 0 0 20px;
      color: #00e5ff;
      font-size: 1.8rem;
    }
    div { max-width: 480px; width: 100%; }
    .hidden { display: none; }
    #login, #app { background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
    #login { text-align: center; }
    button {
      margin: 8px 4px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #00bcd4;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover { background: #0097a7; }
    .btn.delete { background: #e53935; color: #fff; }
    .btn.delete:hover { background: #d32f2f; }

    input {
      width: calc(100% - 24px);
      margin: 8px 0;
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      background: #2c2c2c;
      color: #fff;
      font-size: 1rem;
    }

    #serversList {
      margin-top: 16px;
      display: grid;
      gap: 12px;
    }

    .server-card {
      background: #292929;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .server-title { font-weight: bold; margin-bottom: 6px; }
    .server-buttons { margin-bottom: 10px; }
    .join-link {
      padding: 6px 10px;
      background: #4dd0e1;
      border-radius: 6px;
      color: #000;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .join-link:hover { background: #26c6da; }
  </style>
</body>
</html>
