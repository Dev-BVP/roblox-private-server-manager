<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Private Server Manager</title>
  <style>
    /* DARK THEME */
    body {
      margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212; color: #eee;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }
    #login, #app {
      max-width: 900px; margin: 1.5rem auto; padding: 1rem 2rem 3rem;
      box-sizing: border-box;
    }
    h1 {
      margin-bottom: 1rem;
    }
    #unlimitedMsg {
      margin-bottom: 1rem;
      font-weight: bold;
      color: #f1c40f;
      font-size: 1.1rem;
    }
    button {
      background-color: #3a3a3a;
      border: none; border-radius: 5px; color: #eee;
      padding: 0.5rem 1rem; margin: 0 0.5rem 0.5rem 0;
      font-size: 1rem; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #555;
    }
    button.danger {
      background-color: #d14343;
    }
    button.danger:hover {
      background-color: #e24f4f;
    }
    button.favorite {
      background-color: #f1c40f;
      color: #222;
    }
    button.favorite:hover {
      background-color: #d4ac0d;
    }
    button#switchAccountBtn {
      float: right;
      background-color: #2777f7;
      margin-bottom: 1rem;
    }
    .hidden {
      display: none !important;
    }
    input[type="text"], input[type="password"], input[type="url"], input[type="email"] {
      width: 100%; padding: 0.5rem; margin-bottom: 1rem;
      background: #222; border: none; border-radius: 6px; color: #eee;
      font-size: 1rem;
      box-sizing: border-box;
    }
    label {
      font-weight: 600;
      margin-bottom: 0.3rem;
      display: block;
    }
    /* Server list */
    .server-item, .friend-item, .shared-server-item {
      background: #222; border-radius: 8px; padding: 0.7rem 1rem; margin-bottom: 1rem;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap;
    }
    .server-info, .friend-info {
      flex-grow: 1; min-width: 200px;
      word-break: break-word;
    }
    .btn-group button {
      font-size: 0.9rem;
    }
    .section {
      margin-top: 2rem;
    }
    .share-panel {
      margin-top: 0.8rem;
      background-color: #2a2a2a;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    .checkbox-inline {
      display: inline-block;
      margin-right: 1rem;
      user-select: none;
    }
    /* Scroll container for lists */
    #friendsList, #sharedServersList {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 0.5rem;
      background: #1a1a1a;
    }
    /* Responsive tweaks */
    @media(max-width:600px) {
      #login, #app {
        padding: 1rem 1rem 2rem;
      }
      button {
        margin-bottom: 0.4rem;
      }
      #switchAccountBtn {
        float: none;
        width: 100%;
        margin-bottom: 1rem;
      }
      .server-item, .friend-item, .shared-server-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-group {
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h1>Roblox Private Server Manager</h1>
  <button id="googleSignInBtn">Sign in with Google</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <button id="switchAccountBtn" title="Switch Google Account">Switch Account</button>
  <div id="unlimitedMsg" class="hidden"></div>

  <h1>Your Private Servers</h1>

  <div>
    <label for="serverLinkInput">Private Server Link</label>
    <input type="url" id="serverLinkInput" placeholder="https://www.roblox.com/share?code=YOUR_CODE" />
    <label for="serverNameInput">Server Name (optional)</label>
    <input type="text" id="serverNameInput" placeholder="Enter a friendly name for this server" />
    <label for="pinInput">4-digit PIN</label>
    <input type="password" id="pinInput" maxlength="4" placeholder="Set or enter your 4-digit PIN" />
    <button id="addServerBtn">Add Server</button>
  </div>

  <div id="serversList" class="section"></div>

  <h2>Friends</h2>
  <div>
    <label for="friendEmailInput">Add Friend by Email</label>
    <input type="email" id="friendEmailInput" placeholder="friend@example.com" />
    <button id="addFriendBtn">Add Friend</button>
  </div>
  <div id="friendsList" class="section"></div>

  <h2>Servers Shared With Me</h2>
  <div id="sharedServersList" class="section"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    query,
    where,
    onSnapshot,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDM9zEhD6qnur2RY4zK5ZQ_TbJVkESsnRw",
    authDomain: "roblox-server-manager.firebaseapp.com",
    projectId: "roblox-server-manager",
    storageBucket: "roblox-server-manager.firebasestorage.app",
    messagingSenderId: "223404001099",
    appId: "1:223404001099:web:4eee47729061301c158ace",
    measurementId: "G-G9PV6GD2KN"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // UI Elements
  const loginDiv = document.getElementById("login");
  const appDiv = document.getElementById("app");
  const googleSignInBtn = document.getElementById("googleSignInBtn");
  const switchAccountBtn = document.getElementById("switchAccountBtn");
  const unlimitedMsg = document.getElementById("unlimitedMsg");

  const serverLinkInput = document.getElementById("serverLinkInput");
  const serverNameInput = document.getElementById("serverNameInput");
  const pinInput = document.getElementById("pinInput");
  const addServerBtn = document.getElementById("addServerBtn");
  const serversList = document.getElementById("serversList");

  const friendEmailInput = document.getElementById("friendEmailInput");
  const addFriendBtn = document.getElementById("addFriendBtn");
  const friendsList = document.getElementById("friendsList");

  const sharedServersList = document.getElementById("sharedServersList");

  let currentUser = null;
  let userPin = null;
  let unlimitedUser = false;

  function showAlert(text) {
    alert(text);
  }

  function updateUI(user) {
    if (user) {
      loginDiv.classList.add("hidden");
      appDiv.classList.remove("hidden");
      switchAccountBtn.style.display = "inline-block";
      currentUser = user;
      userPin = null;
      unlimitedUser = (user.email && user.email.toLowerCase() === "bvpstudios012@gmail.com");
      if (unlimitedUser) {
        unlimitedMsg.textContent = "ðŸ”¥ You have unlimited server storage! ðŸ”¥";
        unlimitedMsg.classList.remove("hidden");
      } else {
        unlimitedMsg.textContent = "";
        unlimitedMsg.classList.add("hidden");
      }
      setupRealtimeListeners();
    } else {
      loginDiv.classList.remove("hidden");
      appDiv.classList.add("hidden");
      switchAccountBtn.style.display = "none";
      currentUser = null;
      userPin = null;
      unlimitedUser = false;
      unlimitedMsg.textContent = "";
      unlimitedMsg.classList.add("hidden");
      clearLists();
    }
  }

  function clearLists() {
    serversList.innerHTML = "";
    friendsList.innerHTML = "";
    sharedServersList.innerHTML = "";
  }

  // --- AUTH EVENTS ---

  googleSignInBtn.onclick = async () => {
    try {
      await signInWithPopup(auth, provider.setCustomParameters({ prompt: "select_account" }));
    } catch (e) {
      showAlert("Sign in failed: " + e.message);
    }
  };

  switchAccountBtn.onclick = async () => {
    try {
      await signInWithPopup(auth, provider.setCustomParameters({ prompt: "select_account" }));
    } catch (e) {
      showAlert("Switch account failed: " + e.message);
    }
  };

  onAuthStateChanged(auth, (user) => {
    updateUI(user);
  });

  // --- SERVERS LOGIC ---

  async function addServer() {
    const link = serverLinkInput.value.trim();
    const nameRaw = serverNameInput.value.trim();
    const pin = pinInput.value.trim();

    if (!link) return showAlert("Enter a private server link.");
    if (!pin || !/^\d{4}$/.test(pin)) return showAlert("Enter a valid 4-digit PIN.");

    if (!userPin) {
      userPin = pin;
    } else if (pin !== userPin) {
      return showAlert("Incorrect PIN.");
    }

    if (!unlimitedUser) {
      const userServersCol = collection(db, "users", currentUser.uid, "servers");
      const snap = await getDocs(userServersCol);
      if (snap.size >= 10) return showAlert("Maximum 10 servers allowed.");
    }

    // Extract or fallback name:
    let serverName = nameRaw;
    if (!serverName) {
      const match = link.match(/code=([a-f0-9]+)/i);
      serverName = match ? `Server ${match[1].substring(0,6)}` : "Private Server";
    }

    try {
      await setDoc(doc(collection(db, "users", currentUser.uid, "servers")), {
        link,
        name: serverName,
        favorites: false,
        sharedWith: [],
        createdAt: new Date()
      });
      serverLinkInput.value = "";
      serverNameInput.value = "";
      pinInput.value = "";
    } catch (e) {
      showAlert("Failed to add server: " + e.message);
    }
  }

  addServerBtn.onclick = addServer;

  // --- RENDER SERVERS ---

  function renderServers(serversData) {
    serversList.innerHTML = "";
    if (serversData.length === 0) {
      serversList.innerHTML = "<p style='color:#999;'>No private servers added yet.</p>";
      return;
    }
    serversData.forEach(({ id, data }) => {
      const srv = data;

      const div = document.createElement("div");
      div.className = "server-item";

      const info = document.createElement("div");
      info.className = "server-info";
      info.textContent = srv.name || `Private Server ${id.substring(0, 6)}`;

      const btnGroup = document.createElement("div");
      btnGroup.className = "btn-group";

      const joinBtn = document.createElement("button");
      joinBtn.textContent = "Join";
      joinBtn.onclick = () => window.open(srv.link, "_blank", "noopener");

      const favBtn = document.createElement("button");
      favBtn.textContent = srv.favorites ? "Unfavorite" : "Favorite";
      favBtn.className = srv.favorites ? "favorite" : "";
      favBtn.onclick = async () => {
        try {
          await updateDoc(doc(db, "users", currentUser.uid, "servers", id), {
            favorites: !srv.favorites,
          });
        } catch (e) {
          showAlert("Failed to update favorite: " + e.message);
        }
      };

      const shareBtn = document.createElement("button");
      shareBtn.textContent = "Share";
      shareBtn.onclick = () => {
        toggleSharePanel(id, srv);
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "danger";
      deleteBtn.onclick = async () => {
        const pin = prompt("Enter your 4-digit PIN to delete this server:");
        if (pin === userPin) {
          try {
            await deleteDoc(doc(db, "users", currentUser.uid, "servers", id));
          } catch (e) {
            showAlert("Failed to delete server: " + e.message);
          }
        } else {
          showAlert("Incorrect PIN.");
        }
      };

      btnGroup.appendChild(joinBtn);
      btnGroup.appendChild(favBtn);
      btnGroup.appendChild(shareBtn);
      btnGroup.appendChild(deleteBtn);

      div.appendChild(info);
      div.appendChild(btnGroup);

      serversList.appendChild(div);
    });
  }

  // --- SHARE PANEL ---

  let openSharePanelId = null;
  function toggleSharePanel(serverId, serverData) {
    clearSharePanel();
    if (openSharePanelId === serverId) {
      openSharePanelId = null;
      return;
    }
    openSharePanelId = serverId;

    const serverDiv = [...serversList.children].find(div => {
      return div.querySelector(".server-info").textContent === (serverData.name || "") ||
             div.querySelector(".btn-group button").textContent === "Share";
    });
    if (!serverDiv) return;

    const panel = document.createElement("div");
    panel.className = "share-panel";

    // Share with all checkbox
    const shareAllLabel = document.createElement("label");
    const shareAllCheckbox = document.createElement("input");
    shareAllCheckbox.type = "checkbox";
    shareAllCheckbox.checked = serverData.sharedWith?.includes("all");
    shareAllLabel.appendChild(shareAllCheckbox);
    shareAllLabel.appendChild(document.createTextNode(" Share with all friends"));
    panel.appendChild(shareAllLabel);

    // Friends list
    const friendsDiv = document.createElement("div");
    friendsDiv.style.maxHeight = "120px";
    friendsDiv.style.overflowY = "auto";
    friendsDiv.style.marginTop = "0.5rem";

    (async () => {
      const friendsSnap = await getDocs(collection(db, "users", currentUser.uid, "friends"));
      friendsSnap.docs.forEach(friendDoc => {
        const friendId = friendDoc.id;
        const friendEmail = friendDoc.data().email;

        if (friendEmail === currentUser.email) return;

        const label = document.createElement("label");
        label.className = "checkbox-inline";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = serverData.sharedWith?.includes(friendId);
        cb.disabled = shareAllCheckbox.checked;

        cb.addEventListener("change", async () => {
          try {
            let newSharedWith = serverData.sharedWith || [];
            if (cb.checked) {
              if (!newSharedWith.includes(friendId)) newSharedWith.push(friendId);
            } else {
              newSharedWith = newSharedWith.filter(id => id !== friendId);
            }
            if (newSharedWith.includes("all")) {
              newSharedWith = newSharedWith.filter(id => id !== "all");
              shareAllCheckbox.checked = false;
            }
            await updateDoc(doc(db, "users", currentUser.uid, "servers", serverId), {
              sharedWith: newSharedWith
            });
            serverData.sharedWith = newSharedWith; // update local cache
          } catch (e) {
            showAlert("Error updating shared list: " + e.message);
          }
        });

        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + friendEmail));
        friendsDiv.appendChild(label);
      });
    })();

    panel.appendChild(friendsDiv);

    shareAllCheckbox.addEventListener("change", async () => {
      try {
        let newSharedWith = [];
        if (shareAllCheckbox.checked) {
          newSharedWith = ["all"];
        }
        await updateDoc(doc(db, "users", currentUser.uid, "servers", serverId), {
          sharedWith: newSharedWith
        });
        serverData.sharedWith = newSharedWith; // update local cache
        Array.from(friendsDiv.querySelectorAll("input[type=checkbox]")).forEach(cb => {
          cb.disabled = shareAllCheckbox.checked;
          if (shareAllCheckbox.checked) cb.checked = false;
        });
      } catch (e) {
        showAlert("Error updating share all: " + e.message);
      }
    });

    serverDiv.appendChild(panel);
  }

  function clearSharePanel() {
    const panels = serversList.querySelectorAll(".share-panel");
    panels.forEach(p => p.remove());
  }

  // --- FRIENDS MANAGEMENT ---

  addFriendBtn.onclick = async () => {
    const email = friendEmailInput.value.trim();
    if (!email) return showAlert("Enter a friend's email.");
    if (email === currentUser.email) return showAlert("You cannot add yourself as a friend.");

    try {
      // Search for user by email
      const usersCol = collection(db, "users");
      const q = query(usersCol, where("email", "==", email));
      const snap = await getDocs(q);
      if (snap.empty) {
        showAlert("User not found.");
        return;
      }
      const friendDoc = snap.docs[0];
      const friendId = friendDoc.id;

      // Add friend reference to current user's friend list
      await setDoc(doc(db, "users", currentUser.uid, "friends", friendId), {
        email,
      });
      friendEmailInput.value = "";
    } catch (e) {
      showAlert("Failed to add friend: " + e.message);
    }
  };

  function renderFriends(friendsData) {
    friendsList.innerHTML = "";
    if (friendsData.length === 0) {
      friendsList.innerHTML = "<p style='color:#999;'>No friends added yet.</p>";
      return;
    }
    friendsData.forEach(({ id, data }) => {
      const div = document.createElement("div");
      div.className = "friend-item";

      const info = document.createElement("div");
      info.className = "friend-info";
      info.textContent = data.email;

      const removeBtn = document.createElement("button");
      removeBtn.textContent = "Remove";
      removeBtn.className = "danger";
      removeBtn.onclick = async () => {
        try {
          await deleteDoc(doc(db, "users", currentUser.uid, "friends", id));
        } catch (e) {
          showAlert("Failed to remove friend: " + e.message);
        }
      };

      div.appendChild(info);
      div.appendChild(removeBtn);
      friendsList.appendChild(div);
    });
  }

  // --- SHARED SERVERS ---

  async function refreshSharedServers() {
    sharedServersList.innerHTML = "";
    const usersCol = collection(db, "users");
    const usersSnap = await getDocs(usersCol);
    const otherUsers = usersSnap.docs.filter(doc => doc.id !== currentUser.uid);

    let sharedServers = [];

    for (const userDoc of otherUsers) {
      const serversCol = collection(db, "users", userDoc.id, "servers");
      const q = query(serversCol, where("sharedWith", "array-contains-any", [currentUser.uid, "all"]));
      const serversSnap = await getDocs(q);
      serversSnap.forEach(serverDoc => {
        const data = serverDoc.data();
        sharedServers.push({
          id: serverDoc.id,
          ownerId: userDoc.id,
          ownerEmail: userDoc.data().email || "Friend",
          ...data
        });
      });
    }

    if (sharedServers.length === 0) {
      sharedServersList.innerHTML = "<p style='color:#999;'>No servers shared with you yet.</p>";
      return;
    }

    sharedServers.forEach(srv => {
      const div = document.createElement("div");
      div.className = "shared-server-item";

      const info = document.createElement("div");
      info.className = "server-info";
      info.textContent = `${srv.name || "Shared Server"} from ${srv.ownerEmail}`;

      const joinBtn = document.createElement("button");
      joinBtn.textContent = "Join";
      joinBtn.onclick = () => {
        if (srv.link) window.open(srv.link, "_blank", "noopener");
        else showAlert("No link available.");
      };

      div.appendChild(info);
      div.appendChild(joinBtn);
      sharedServersList.appendChild(div);
    });
  }

  // --- REALTIME LISTENERS ---

  let unsubscribeServers = null;
  let unsubscribeFriends = null;
  let sharedServersInterval = null;

  function setupRealtimeListeners() {
    if (unsubscribeServers) unsubscribeServers();
    if (unsubscribeFriends) unsubscribeFriends();
    if (sharedServersInterval) clearInterval(sharedServersInterval);

    const userServersCol = collection(db, "users", currentUser.uid, "servers");
    unsubscribeServers = onSnapshot(userServersCol, (snapshot) => {
      const serversData = snapshot.docs.map(d => ({ id: d.id, data: d.data() }));
      renderServers(serversData);
    });

    const userFriendsCol = collection(db, "users", currentUser.uid, "friends");
    unsubscribeFriends = onSnapshot(userFriendsCol, (snapshot) => {
      const friendsData = snapshot.docs.map(d => ({ id: d.id, data: d.data() }));
      renderFriends(friendsData);
    });

    refreshSharedServers();
    sharedServersInterval = setInterval(refreshSharedServers, 15000);
  }
</script>

</body>
</html>
