<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Roblox Private Server Manager</title>
<style>
  /* --- Basic reset and layout --- */
  body {
    margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212; color: #eee;
  }
  #app, #login {
    max-width: 800px; margin: 2rem auto; padding: 1rem;
  }

  /* --- Buttons --- */
  button {
    background-color: #3a3a3a;
    border: none; border-radius: 4px; color: #eee; padding: 0.5rem 1rem;
    cursor: pointer; transition: background-color 0.3s;
    margin: 0 0.3rem 0.3rem 0;
  }
  button:hover {
    background-color: #555;
  }
  button.danger {
    background-color: #b53939;
  }
  button.danger:hover {
    background-color: #d04141;
  }

  /* --- Lists --- */
  .server-item, .friend-item, .shared-server-item {
    background: #222; border-radius: 6px; padding: 0.8rem; margin-bottom: 0.8rem;
    display: flex; justify-content: space-between; align-items: center;
    flex-wrap: wrap;
  }
  .server-info, .friend-info {
    flex-grow: 1; min-width: 220px;
  }
  .btn-group {
    flex-shrink: 0;
  }

  /* --- Tags --- */
  .tag {
    background-color: #3a88f7;
    color: white; padding: 0.2rem 0.6rem; border-radius: 4px;
    font-size: 0.8rem; margin-left: 0.5rem;
  }
  .tag.shared {
    background-color: #35a835;
  }
  .tag.imported {
    background-color: #f0a335;
  }
  .badge-domain {
    background-color: #555;
    font-size: 0.75rem; padding: 0.15rem 0.4rem; margin-left: 0.3rem;
    border-radius: 3px;
  }
  .badge-domain.edu {
    background-color: #7a52f7;
  }

  /* --- Inputs --- */
  input[type="text"], input[type="password"], input[type="email"] {
    padding: 0.5rem; border-radius: 4px; border: none;
    margin-bottom: 0.5rem; width: 100%;
    box-sizing: border-box;
    background: #222; color: #eee;
  }
  label {
    font-weight: 600; margin-bottom: 0.25rem; display: block;
  }

  /* --- Hidden class (FIXED) --- */
  .hidden {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
    opacity: 0 !important;
    user-select: none !important;
  }

  /* --- Modal styles --- */
  #shareModal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background-color: #1e1e1e;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    width: 90%;
    max-width: 480px;
    z-index: 1000;
    color: #ddd;
  }
  #shareModal h3 {
    margin-top: 0; margin-bottom: 1rem;
  }
  #shareFriendsList {
    max-height: 180px;
    overflow-y: auto;
    margin-bottom: 1rem;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 0.5rem;
  }
  .checkbox-label {
    display: flex; align-items: center; margin-bottom: 0.4rem;
  }
  .checkbox-label input[type="checkbox"] {
    margin-right: 0.5rem;
    cursor: pointer;
  }

  /* Modal buttons */
  #shareModal button {
    margin-right: 0.8rem;
  }

  /* Overlay to darken background when modal is open */
  #modalOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.65);
    z-index: 999;
  }
  #modalOverlay.hidden {
    display: none !important;
  }

</style>
</head>
<body>

<div id="login" class="hidden">
  <h2>Sign In</h2>
  <button id="googleSignInBtn">Sign in with Google</button>
</div>

<div id="app" class="hidden">
  <h1>Roblox Private Server Manager</h1>

  <section>
    <h2>Your Servers</h2>
    <div id="serversList"></div>
  </section>

  <section>
    <h2>Add / Edit Server</h2>
    <label for="linkInput">Server Link</label>
    <input type="text" id="linkInput" placeholder="https://www.roblox.com/share?code=..." />
    <label for="nameInput">Server Name (optional)</label>
    <input type="text" id="nameInput" placeholder="Name your server" />
    <label for="pinInput">4-digit PIN</label>
    <input type="password" id="pinInput" placeholder="Enter your PIN" maxlength="4" />
    <button id="addBtn">Add / Save Server</button>
  </section>

  <section>
    <h2>Friends</h2>
    <input type="email" id="friendEmailInput" placeholder="Friend's Google Email" />
    <button id="addFriendBtn">Add Friend</button>
    <div id="friendsList"></div>
  </section>

  <section>
    <h2>Servers Shared With Me</h2>
    <div id="sharedWithMeList"></div>
  </section>

  <button id="forgotBtn">Forgot PIN</button>
  <button id="signOutBtn">Sign Out</button>
</div>

<!-- Modal overlay -->
<div id="modalOverlay" class="hidden"></div>

<!-- Share modal -->
<div id="shareModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle" aria-describedby="shareModalDesc">
  <h3 id="shareModalTitle">Share Server With Friends</h3>
  <div id="shareFriendsList"></div>
  <label>
    <input type="checkbox" id="shareAllFriendsToggle" />
    Show to All Friends
  </label>
  <div style="margin-top: 1rem;">
    <button id="shareSaveBtn">Save</button>
    <button id="shareCancelBtn">Cancel</button>
  </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDM9zEhD6qnur2RY4zK5ZQ_TbJVkESsnRw",
  authDomain: "roblox-server-manager.firebaseapp.com",
  projectId: "roblox-server-manager",
  storageBucket: "roblox-server-manager.firebasestorage.app",
  messagingSenderId: "223404001099",
  appId: "1:223404001099:web:4eee47729061301c158ace",
  measurementId: "G-G9PV6GD2KN"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const auth = getAuth();
const db = getFirestore();

const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const googleSignInBtn = document.getElementById("googleSignInBtn");
const signOutBtn = document.getElementById("signOutBtn");

const serversList = document.getElementById("serversList");
const addBtn = document.getElementById("addBtn");
const linkInput = document.getElementById("linkInput");
const nameInput = document.getElementById("nameInput");
const pinInput = document.getElementById("pinInput");

const friendEmailInput = document.getElementById("friendEmailInput");
const addFriendBtn = document.getElementById("addFriendBtn");
const friendsList = document.getElementById("friendsList");

const sharedWithMeList = document.getElementById("sharedWithMeList");

const forgotBtn = document.getElementById("forgotBtn");

const shareModal = document.getElementById("shareModal");
const modalOverlay = document.getElementById("modalOverlay");
const shareFriendsList = document.getElementById("shareFriendsList");
const shareAllFriendsToggle = document.getElementById("shareAllFriendsToggle");
const shareSaveBtn = document.getElementById("shareSaveBtn");
const shareCancelBtn = document.getElementById("shareCancelBtn");

let currentUser = null;
let accountData = { pin: "", servers: [], friends: [] };
let usersPublic = [];
let editingServerIndex = null;
let sharingServerIndex = null;

// --- AUTH ---

googleSignInBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    alert("Sign in failed: " + e.message);
  }
};

signOutBtn.onclick = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");

    await saveUserPublicInfo(user);
    await fetchUsersPublic();
    await fetchAccount();
    renderAll();
  } else {
    currentUser = null;
    loginDiv.classList.remove("hidden");
    appDiv.classList.add("hidden");
  }
});

async function saveUserPublicInfo(user) {
  const ref = doc(db, "usersPublic", user.uid);
  const snapshot = await getDoc(ref);
  if (!snapshot.exists()) {
    await setDoc(ref, {
      displayName: user.displayName || "Unnamed",
      email: user.email || "",
      createdAt: new Date().toISOString(),
    });
  }
}

// Fetch the current user's account data
async function fetchAccount() {
  const ref = doc(db, "users", currentUser.uid);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    accountData = snap.data();
    if (!accountData.pin) accountData.pin = "";
    if (!accountData.servers) accountData.servers = [];
    if (!accountData.friends) accountData.friends = [];
  } else {
    accountData = { pin: "", servers: [], friends: [] };
  }
}

// Save user's account data
async function saveAccount() {
  const ref = doc(db, "users", currentUser.uid);
  await setDoc(ref, accountData);
}

// --- RENDER FUNCTIONS ---

function renderAll() {
  renderServers();
  renderFriends();
  renderSharedWithMe();
}

function renderServers() {
  serversList.innerHTML = "";
  if (!accountData.servers.length) {
    serversList.innerHTML = `<p style="color:#999; font-style:italic;">No servers added yet.</p>`;
    return;
  }
  accountData.servers.forEach((srv, i) => {
    const item = document.createElement("div");
    item.className = "server-item";

    const info = document.createElement("div");
    info.className = "server-info";

    const linkText = srv.link || "Unknown link";
    const nameText = srv.name || extractNameFromLink(linkText);
    const domain = extractDomain(linkText);
    const addedDate = srv.addedAt ? new Date(srv.addedAt) : null;

    let badges = "";
    if (srv.sharedWith) badges += `<span class="tag shared">Shared</span> `;
    if (srv.imported) badges += `<span class="tag imported">Imported</span> `;

    info.innerHTML = `
      <strong>${escapeHtml(nameText)}</strong>
      <small>${escapeHtml(linkText)}</small>
      ${domain ? `<span class="badge-domain ${domain.includes('.edu') ? 'edu' : ''}">${escapeHtml(domain)}</span>` : ''}
      ${addedDate ? `<small>Added: ${addedDate.toLocaleDateString()}</small>` : ''}
      ${badges}
    `;

    const btnGroup = document.createElement("div");
    btnGroup.className = "btn-group";

    // Join button
    const joinBtn = document.createElement("button");
    joinBtn.textContent = "Join";
    joinBtn.title = "Open server link in new tab";
    joinBtn.onclick = () => window.open(srv.link, "_blank", "noopener");

    // Edit button
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.onclick = () => openEditServer(i);

    // Delete button
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.classList.add("danger");
    deleteBtn.onclick = () => deleteServer(i);

    // Share button
    const shareBtn = document.createElement("button");
    shareBtn.textContent = "Share";
    shareBtn.title = "Share this server with friends";
    shareBtn.onclick = () => openShareModal(i);

    btnGroup.append(joinBtn, editBtn, deleteBtn, shareBtn);
    item.append(info, btnGroup);
    serversList.appendChild(item);
  });
}

function renderFriends() {
  friendsList.innerHTML = "";
  if (!accountData.friends || !accountData.friends.length) {
    friendsList.innerHTML = `<p style="color:#999; font-style:italic;">No friends added yet.</p>`;
    return;
  }
  accountData.friends.forEach(uid => {
    const friend = usersPublic.find(u => u.uid === uid);
    const item = document.createElement("div");
    item.className = "friend-item";

    const info = document.createElement("div");
    info.className = "friend-info";

    if (friend) {
      info.innerHTML = `<strong>${escapeHtml(friend.displayName)}</strong><small>${escapeHtml(friend.email)}</small>`;
    } else {
      info.innerHTML = `<strong>Unknown User</strong><small>UID: ${escapeHtml(uid)}</small>`;
    }

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove";
    removeBtn.classList.add("danger");
    removeBtn.onclick = () => removeFriend(uid);

    item.append(info, removeBtn);
    friendsList.appendChild(item);
  });
}

function renderSharedWithMe() {
  sharedWithMeList.innerHTML = "";

  if (!usersPublic.length || !accountData.friends || accountData.friends.length === 0) {
    sharedWithMeList.innerHTML = `<p style="color:#999; font-style:italic;">No servers shared with you yet.</p>`;
    return;
  }

  // Gather servers shared with currentUser from friends
  let sharedServers = [];

  const friendUsers = usersPublic.filter(u => accountData.friends.includes(u.uid));
  if (!friendUsers.length) {
    sharedWithMeList.innerHTML = `<p style="color:#999; font-style:italic;">No servers shared with you yet.</p>`;
    return;
  }

  Promise.all(friendUsers.map(async friend => {
    const ref = doc(db, "users", friend.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const servers = snap.data().servers || [];
      servers.forEach(srv => {
        if (!srv.sharedWith) return;
        if (srv.sharedWith === "ALL_FRIENDS" || (Array.isArray(srv.sharedWith) && srv.sharedWith.includes(currentUser.uid))) {
          sharedServers.push({...srv, owner: friend});
        }
      });
    }
  })).then(() => {
    if (!sharedServers.length) {
      sharedWithMeList.innerHTML = `<p style="color:#999; font-style:italic;">No servers shared with you yet.</p>`;
      return;
    }
    sharedServers.sort((a,b) => {
      if(a.owner.displayName.toLowerCase() < b.owner.displayName.toLowerCase()) return -1;
      if(a.owner.displayName.toLowerCase() > b.owner.displayName.toLowerCase()) return 1;
      if((a.name||"") < (b.name||"")) return -1;
      if((a.name||"") > (b.name||"")) return 1;
      return 0;
    });

    sharedWithMeList.innerHTML = "";
    sharedServers.forEach(srv => {
      const div = document.createElement("div");
      div.className = "shared-server-item";

      const info = document.createElement("div");
      info.className = "server-info";
      info.innerHTML = `<strong>${escapeHtml(srv.name || extractNameFromLink(srv.link))}</strong>
        <small>Shared by: ${escapeHtml(srv.owner.displayName)} (${escapeHtml(srv.owner.email)})</small>
        <small>${escapeHtml(srv.link)}</small>`;

      const btnGroup = document.createElement("div");
      btnGroup.className = "btn-group";

      const joinBtn = document.createElement("button");
      joinBtn.textContent = "Join";
      joinBtn.title = "Open server link in new tab";
      joinBtn.onclick = () => window.open(srv.link, "_blank", "noopener");

      const importBtn = document.createElement("button");
      importBtn.textContent = "Import";
      importBtn.title = "Add this server to your own list";
      importBtn.onclick = () => importSharedServer(srv);

      btnGroup.append(joinBtn, importBtn);
      div.append(info, btnGroup);

      sharedWithMeList.appendChild(div);
    });
  });
}

// --- EVENT HANDLERS ---

addBtn.onclick = async () => {
  const link = linkInput.value.trim();
  let name = nameInput.value.trim();
  const pin = pinInput.value.trim();

  if (!link) {
    alert("Please enter a server link.");
    return;
  }
  if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
    alert("Please enter a valid 4-digit PIN.");
    return;
  }

  if (accountData.pin && accountData.pin !== pin) {
    alert("Incorrect PIN.");
    return;
  }

  if (!accountData.pin) {
    accountData.pin = pin;
  }

  if (!name) {
    name = extractNameFromLink(link);
  }

  // Check if editing
  if (editingServerIndex !== null) {
    accountData.servers[editingServerIndex].link = link;
    accountData.servers[editingServerIndex].name = name;
  } else {
    if (accountData.servers.length >= 10) {
      alert("Maximum 10 servers allowed.");
      return;
    }
    accountData.servers.push({
      link,
      name,
      addedAt: new Date().toISOString()
    });
  }

  editingServerIndex = null;
  linkInput.value = "";
  nameInput.value = "";
  pinInput.value = "";

  await saveAccount();
  renderServers();
};

function openEditServer(index) {
  editingServerIndex = index;
  const srv = accountData.servers[index];
  linkInput.value = srv.link;
  nameInput.value = srv.name || "";
  pinInput.value = "";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function deleteServer(index) {
  const pin = prompt("Enter your 4-digit PIN to delete this server:");
  if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
    alert("Invalid PIN.");
    return;
  }
  if (pin !== accountData.pin) {
    alert("Incorrect PIN.");
    return;
  }
  accountData.servers.splice(index, 1);
  await saveAccount();
  renderServers();
}

// --- FRIENDS ---

addFriendBtn.onclick = async () => {
  const email = friendEmailInput.value.trim().toLowerCase();
  if (!email) {
    alert("Enter a valid email.");
    return;
  }
  const user = usersPublic.find(u => u.email.toLowerCase() === email);
  if (!user) {
    alert("No registered user found with that email.");
    return;
  }
  if (accountData.friends.includes(user.uid)) {
    alert("Friend already added.");
    return;
  }
  if (accountData.friends.length >= 10) {
    alert("Maximum 10 friends allowed.");
    return;
  }
  accountData.friends.push(user.uid);
  await saveAccount();
  friendEmailInput.value = "";
  renderFriends();
};

async function removeFriend(uid) {
  const idx = accountData.friends.indexOf(uid);
  if (idx !== -1) {
    accountData.friends.splice(idx, 1);
    await saveAccount();
    renderFriends();
    renderSharedWithMe();
  }
}

// --- SHARING ---

function openShareModal(serverIndex) {
  sharingServerIndex = serverIndex;
  shareFriendsList.innerHTML = "";
  shareAllFriendsToggle.checked = false;

  if (!accountData.friends || accountData.friends.length === 0) {
    shareFriendsList.innerHTML = "<p>No friends to share with.</p>";
  } else {
    accountData.friends.forEach(friendUid => {
      const friend = usersPublic.find(u => u.uid === friendUid);
      if (!friend) return;

      const label = document.createElement("label");
      label.className = "checkbox-label";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = friend.uid;

      // If already shared, check box
      const srv = accountData.servers[serverIndex];
      if (srv.sharedWith) {
        if (srv.sharedWith === "ALL_FRIENDS") {
          shareAllFriendsToggle.checked = true;
          checkbox.disabled = true;
        } else if (Array.isArray(srv.sharedWith) && srv.sharedWith.includes(friend.uid)) {
          checkbox.checked = true;
        }
      }

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(friend.displayName || friend.email));
      shareFriendsList.appendChild(label);
    });
  }

  modalOverlay.classList.remove("hidden");
  shareModal.classList.remove("hidden");
}

shareAllFriendsToggle.onchange = () => {
  const checkboxes = shareFriendsList.querySelectorAll("input[type=checkbox]");
  if (shareAllFriendsToggle.checked) {
    checkboxes.forEach(chk => {
      chk.checked = false;
      chk.disabled = true;
    });
  } else {
    checkboxes.forEach(chk => {
      chk.disabled = false;
    });
  }
};

shareCancelBtn.onclick = () => {
  shareModal.classList.add("hidden");
  modalOverlay.classList.add("hidden");
  sharingServerIndex = null;
};

shareSaveBtn.onclick = async () => {
  if (sharingServerIndex === null) return;

  const srv = accountData.servers[sharingServerIndex];
  if (shareAllFriendsToggle.checked) {
    srv.sharedWith = "ALL_FRIENDS";
  } else {
    const selectedFriends = Array.from(shareFriendsList.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
    srv.sharedWith = selectedFriends.length ? selectedFriends : null;
  }
  await saveAccount();
  shareModal.classList.add("hidden");
  modalOverlay.classList.add("hidden");
  sharingServerIndex = null;
  renderServers();
  renderSharedWithMe();
};

// Import shared server into user's own list
async function importSharedServer(server) {
  if (accountData.servers.length >= 10) {
    alert("Maximum 10 servers allowed.");
    return;
  }
  if (accountData.servers.some(s => s.link === server.link)) {
    alert("You already have this server.");
    return;
  }
  accountData.servers.push({
    link: server.link,
    name: server.name,
    addedAt: new Date().toISOString(),
    imported: true
  });
  await saveAccount();
  renderServers();
}

// --- HELPERS ---

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  })[m]);
}

function extractNameFromLink(link) {
  // Example: https://www.roblox.com/share?code=e210d934cf7f094b896db8832aa704c7&type=Server
  // We'll just grab the code part (without dashes)
  try {
    const url = new URL(link);
    let code = url.searchParams.get("code") || "";
    code = code.replace(/-/g, "");
    if (code.length >= 6) return `Join Server ${code.substring(0,6)}`;
    return "Join Private Server";
  } catch {
    return "Join Private Server";
  }
}

function extractDomain(link) {
  try {
    const url = new URL(link);
    return url.hostname;
  } catch {
    return "";
  }
}

// Fetch public users for friends search
async function fetchUsersPublic() {
  usersPublic = [];
  const querySnapshot = await getDocs(collection(db, "usersPublic"));
  querySnapshot.forEach(doc => {
    usersPublic.push({ uid: doc.id, ...doc.data() });
  });
}

// --- PIN RESET (simplified) ---
forgotBtn.onclick = () => {
  alert("Pin reset feature coming soon! For now, contact support.");
};

// On page load
(async () => {
  // Just trigger auth state check
  // (will auto show login or app)
})();

</script>

</body>
</html>
