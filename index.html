<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Private Server Manager with Sharing</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      font-family: 'Roboto', sans-serif;
      background: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
    }
    h1 {
      font-weight: 700;
      margin-bottom: 16px;
      user-select: none;
    }
    #container {
      background: #1e1e1e;
      padding: 24px 30px;
      border-radius: 14px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    button {
      background: #00bcd4;
      border: none;
      border-radius: 8px;
      color: #000;
      font-weight: 700;
      padding: 10px 18px;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
      box-shadow: 0 4px 8px rgba(0,188,212,0.4);
      margin: 6px 4px 6px 0;
    }
    button:hover, button:focus {
      background: #0097a7;
      box-shadow: 0 6px 12px rgba(0,151,167,0.7);
      outline: none;
    }
    button:active {
      background: #00838f;
      box-shadow: 0 2px 6px rgba(0,131,143,0.7);
    }
    input[type="text"],
    input[type="password"],
    input[type="search"] {
      width: 100%;
      padding: 12px 14px;
      margin: 8px 0 12px 0;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      background: #262626;
      color: #eee;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
      transition: background 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="search"]:focus {
      background: #333;
      outline: none;
      box-shadow: inset 0 2px 6px rgba(0,188,212,0.8);
    }
    .hidden {
      display: none !important;
    }
    section {
      background: #272727;
      border-radius: 12px;
      padding: 18px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
    }
    #serversList, #sharedServersList, #userSearchResults {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .server-item, .user-item {
      background: #1f1f1f;
      border-radius: 10px;
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
    }
    .server-info {
      color: #00bcd4;
      font-weight: 600;
      max-width: 65%;
      word-break: break-word;
    }
    .btn-group {
      display: flex;
      gap: 8px;
    }
    #signInBtn img {
      vertical-align: middle;
      margin-right: 10px;
      height: 22px;
    }
    footer {
      margin-top: auto;
      font-size: 12px;
      color: #555;
      user-select: none;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>Private Server Manager with Sharing</h1>

  <div id="container">

    <div id="login">
      <button id="signInBtn" aria-label="Sign in with Google">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" />
        Sign in with Google
      </button>
    </div>

    <div id="app" class="hidden" role="main" aria-live="polite" aria-label="Private server manager app">

      <section aria-label="User controls">
        <button id="signOutBtn" aria-label="Sign out">Sign Out</button>
        <button id="forgotBtn" aria-label="Reset your account PIN">Forgot PIN?</button>
      </section>

      <section aria-label="Add or edit private server">
        <input id="serverLink" type="text" placeholder="Private server link" aria-required="true" autocomplete="off" />
        <input id="serverName" type="text" placeholder="Optional server name" autocomplete="off" />
        <input id="pinInput" type="password" placeholder="4-digit Account PIN" maxlength="4" aria-required="true" inputmode="numeric" pattern="\d{4}" />
        <button id="addServerBtn" aria-label="Add or edit private server">Add / Edit Private Server</button>
      </section>

      <section aria-label="Your private servers">
        <h2>Your Servers</h2>
        <div id="serversList" tabindex="0" aria-live="polite"></div>
      </section>

      <section aria-label="Search other users to share servers">
        <h2>Search Users</h2>
        <input id="userSearchInput" type="search" placeholder="Search by email" aria-label="Search users by email" autocomplete="off" />
        <button id="userSearchBtn" aria-label="Search users">Search</button>
        <div id="userSearchResults" tabindex="0" aria-live="polite"></div>
      </section>

      <section aria-label="Shared user's servers" class="hidden" id="sharedServersSection">
        <h2 id="sharedUserTitle"></h2>
        <div id="sharedServersList"></div>
      </section>

    </div>
  </div>

  <footer>Â© 2025 Roblox Server Manager by BVP</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDM9zEhD6qnur2RY4zK5ZQ_TbJVkESsnRw",
      authDomain: "roblox-server-manager.firebaseapp.com",
      projectId: "roblox-server-manager",
      storageBucket: "roblox-server-manager.appspot.com",
      messagingSenderId: "223404001099",
      appId: "1:223404001099:web:4eee47729061301c158ace",
      measurementId: "G-G9PV6GD2KN"
    };
    initializeApp(firebaseConfig);

    const auth = getAuth();
    const provider = new GoogleAuthProvider();
    const db = getFirestore();

    provider.setCustomParameters({ prompt: "select_account" });

    // UI elements
    const signInBtn = document.getElementById("signInBtn"),
          signOutBtn = document.getElementById("signOutBtn"),
          forgotBtn = document.getElementById("forgotBtn"),
          appDiv = document.getElementById("app"),
          loginDiv = document.getElementById("login"),
          serversList = document.getElementById("serversList"),
          linkInput = document.getElementById("serverLink"),
          nameInput = document.getElementById("serverName"),
          pinInput = document.getElementById("pinInput"),
          addBtn = document.getElementById("addServerBtn"),
          userSearchInput = document.getElementById("userSearchInput"),
          userSearchBtn = document.getElementById("userSearchBtn"),
          userSearchResults = document.getElementById("userSearchResults"),
          sharedServersSection = document.getElementById("sharedServersSection"),
          sharedUserTitle = document.getElementById("sharedUserTitle"),
          sharedServersList = document.getElementById("sharedServersList");

    let currentUser = null, accountData = { pin: "", servers: [] }, usersPublic = [];

    // Sign in & sign out
    signInBtn.onclick = async () => {
      try { await signInWithPopup(auth, provider); }
      catch { alert("Sign-in failed."); }
    };
    signOutBtn.onclick = async () => {
      await signOut(auth);
      location.reload();
    };

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        loginDiv.classList.add("hidden");
        appDiv.classList.remove("hidden");
        await saveUserPublicInfo(user);
        setupDevicePin();
        await fetchAccount();
        renderServers();
        clearSearch();
      } else {
        currentUser = null;
        loginDiv.classList.remove("hidden");
        appDiv.classList.add("hidden");
      }
    });

    // Save public user info for searching
    async function saveUserPublicInfo(user) {
      const ref = doc(db, "usersPublic", user.uid);
      await setDoc(ref, {
        email: user.email,
        displayName: user.displayName || user.email
      }, { merge: true });
    }

    // Fetch user account data (servers, pin)
    async function fetchAccount() {
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) accountData = snap.data();
      else accountData = { pin: "", servers: [] };
    }

    async function saveAccount() {
      await setDoc(doc(db, "users", currentUser.uid), accountData);
    }

    function renderServers() {
      serversList.innerHTML = "";
      accountData.servers.forEach((srv, i) => {
        const div = document.createElement("div");
        div.className = "server-item";

        const info = document.createElement("div");
        info.className = "server-info";
        info.textContent = srv.name || srv.link;

        const btnGroup = document.createElement("div");
        btnGroup.className = "btn-group";

        const joinBtn = document.createElement("button");
        joinBtn.textContent = "Join";
        joinBtn.title = "Join this private server";
        joinBtn.onclick = () => window.open(srv.link, "_blank", "noopener");

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.title = "Edit server link/name";
        editBtn.onclick = () => editSrv(i);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.title = "Delete this server";
        delBtn.onclick = () => delSrv(i);

        const shareBtn = document.createElement("button");
        shareBtn.textContent = "Share";
        shareBtn.title = "Copy server link to clipboard";
        shareBtn.onclick = () => {
          navigator.clipboard.writeText(srv.link).then(() => {
            alert("Server link copied to clipboard!");
          }, () => {
            alert("Failed to copy link. Try manually.");
          });
        };

        btnGroup.append(joinBtn, editBtn, delBtn, shareBtn);
        div.append(info, btnGroup);
        serversList.appendChild(div);
      });
    }

    function setupDevicePin() {
      if (!localStorage.getItem("devicePin")) {
        const d = prompt("Set your 4-digit DEVICE PIN:");
        if (/^\d{4}$/.test(d)) localStorage.setItem("devicePin", d);
        else alert("Device PIN must be 4 digits.");
      }
    }

    forgotBtn.onclick = async () => {
      const dp = localStorage.getItem("devicePin");
      if (!dp) return alert("Set device PIN first.");
      const entered = prompt("Enter your DEVICE PIN:");
      if (entered !== dp) return alert("Incorrect device PIN.");
      const np = prompt("Enter NEW 4-digit Account PIN:");
      if (!/^\d{4}$/.test(np)) return alert("Account PIN must be 4 digits.");
      accountData.pin = np;
      await saveAccount();
      alert("Your account PIN has been reset.");
    };

    addBtn.onclick = async () => {
      const link = linkInput.value.trim(), name = nameInput.value.trim(), pin = pinInput.value.trim();
      if (!link || !/^\d{4}$/.test(pin)) return alert("Enter link + 4-digit PIN");
      if (!accountData.pin) accountData.pin = pin;
      if (pin !== accountData.pin) return alert("Incorrect PIN");
      const existing = accountData.servers.find(s => s.link === link);
      if (existing) existing.name = name || link;
      else accountData.servers.push({ link, name: name || link });
      await saveAccount();
      renderServers();
      linkInput.value = nameInput.value = pinInput.value = "";
    };

    async function editSrv(i) {
      const p = prompt("Enter Account PIN:");
      if (p !== accountData.pin) return alert("Incorrect PIN");
      const l = prompt("New link:", accountData.servers[i].link),
            n = prompt("New name:", accountData.servers[i].name);
      if (l && n) {
        accountData.servers[i] = { link: l, name: n };
        await saveAccount();
        renderServers();
      }
    }

    async function delSrv(i) {
      const p = prompt("Enter Account PIN:");
      if (p !== accountData.pin) return alert("Incorrect PIN");
      accountData.servers.splice(i, 1);
      await saveAccount();
      renderServers();
    }

    // User search & import shared servers
    userSearchBtn.onclick = async () => {
      const q = userSearchInput.value.trim().toLowerCase();
      userSearchResults.innerHTML = "";
      sharedServersSection.classList.add("hidden");
      if (!q) return alert("Enter a search term.");

      // Firestore does not support substring queries so:
      // Get limited users, then filter client side (works fine for small scale)
      const usersRef = collection(db, "usersPublic");
      const qSnap = await getDocs(usersRef);
      const filtered = qSnap.docs
        .map(d => ({ uid: d.id, ...d.data() }))
        .filter(u => u.email.toLowerCase().includes(q) && u.uid !== currentUser.uid);

      if (filtered.length === 0) {
        userSearchResults.textContent = "No users found.";
        return;
      }

      filtered.forEach(user => {
        const div = document.createElement("div");
        div.className = "user-item";

        const info = document.createElement("div");
        info.textContent = user.displayName + " (" + user.email + ")";
        info.style.flex = "1";

        const viewBtn = document.createElement("button");
        viewBtn.textContent = "View Servers";
        viewBtn.onclick = () => loadSharedServers(user);

        div.append(info, viewBtn);
        userSearchResults.appendChild(div);
      });
    };

    async function loadSharedServers(user) {
      sharedUserTitle.textContent = `Servers shared by ${user.displayName}`;
      sharedServersList.innerHTML = "";
      sharedServersSection.classList.remove("hidden");

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists() || !snap.data().servers?.length) {
        sharedServersList.textContent = "No servers shared by this user.";
        return;
      }
      const sharedServers = snap.data().servers;

      sharedServers.forEach((srv, i) => {
        const div = document.createElement("div");
        div.className = "server-item";

        const info = document.createElement("div");
        info.className = "server-info";
        info.textContent = srv.name || srv.link;

        const btnGroup = document.createElement("div");
        btnGroup.className = "btn-group";

        const joinBtn = document.createElement("button");
        joinBtn.textContent = "Join";
        joinBtn.title = "Join this private server";
        joinBtn.onclick = () => window.open(srv.link, "_blank", "noopener");

        const importBtn = document.createElement("button");
        importBtn.textContent = "Import";
        importBtn.title = "Copy this server to your list";
        importBtn.onclick = () => importServer(srv);

        btnGroup.append(joinBtn, importBtn);
        div.append(info, btnGroup);
        sharedServersList.appendChild(div);
      });
    }

    async function importServer(server) {
      if (!accountData.pin) {
        alert("You need to set your Account PIN first.");
        return;
      }
      const pin = prompt("Enter your 4-digit Account PIN to import:");
      if (pin !== accountData.pin) {
        alert("Incorrect PIN");
        return;
      }
      const exists = accountData.servers.find(s => s.link === server.link);
      if (exists) {
        alert("You already have this server in your list.");
        return;
      }
      accountData.servers.push(server);
      await saveAccount();
      renderServers();
      alert(`Server "${server.name || server.link}" imported successfully!`);
    }

    function clearSearch() {
      userSearchInput.value = "";
      userSearchResults.innerHTML = "";
      sharedServersList.innerHTML = "";
      sharedServersSection.classList.add("hidden");
    }
  </script>

</body>
</html>
