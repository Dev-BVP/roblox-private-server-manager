<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Server Manager + Friends</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDM9zEhD6qnur2RY4zK5ZQ_TbJVkESsnRw",
      authDomain: "roblox-server-manager.firebaseapp.com",
      projectId: "roblox-server-manager",
      storageBucket: "roblox-server-manager.appspot.com",
      messagingSenderId: "223404001099",
      appId: "1:223404001099:web:4eee47729061301c158ace",
      measurementId: "G-G9PV6GD2KN"
    };
    initializeApp(firebaseConfig);
    const auth = getAuth(), provider = new GoogleAuthProvider();
    const db = getFirestore();
    provider.setCustomParameters({ prompt: "select_account" });

    // UI references
    const signInBtn = document.getElementById("signInBtn"),
          signOutBtn = document.getElementById("signOutBtn"),
          forgotBtn = document.getElementById("forgotBtn"),
          addServerBtn = document.getElementById("addServerBtn"),
          shareBtn = document.getElementById("shareBtn"),
          addFriendBtn = document.getElementById("addFriendBtn"),
          userSearchBtn = document.getElementById("userSearchBtn");

    const rng = id => document.getElementById(id);

    let currentUser = null;
    let account = { pin: "", servers: [], friends: [] };
    let sharedWithMe = [];

    // Auth & initialization
    signInBtn.onclick = () => signInWithPopup(auth, provider).catch(() => alert("Sign-in failed"));
    signOutBtn.onclick = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, async user => {
      if (!user) return;
      currentUser = user;
      document.body.classList.add("app-logged-in");

      // load public profile
      await setDoc(doc(db, "usersPublic", user.uid), {
        email: user.email,
        displayName: user.displayName || user.email
      }, { merge: true });

      // load own account
      const snap = await getDoc(doc(db, "users", user.uid));
      account = snap.exists() ? snap.data() : { pin: "", servers: [], friends: [] };
      await setDoc(doc(db, "users", user.uid), account, { merge: true });

      rng("pinInput").value = "";
      renderAll();
      rng("container").scrollIntoView();
    });

    async function saveAccount() {
      await setDoc(doc(db, "users", currentUser.uid), account);
    }

    // App actions
    addServerBtn.onclick = async () => {
      const link = rng("serverLink").value.trim();
      const name = rng("serverName").value.trim();
      const pin = rng("pinInput").value.trim();
      if (!link || pin.length !== 4) return alert("Link + 4-digit PIN required");
      if (!account.pin) account.pin = pin;
      if (pin !== account.pin) return alert("Wrong PIN");

      account.servers.push({ id: Date.now(), link, name: name || link, sharedWith: [] });
      await saveAccount();
      renderServers();
      rng("serverLink").value = rng("serverName").value = rng("pinInput").value = "";
    };

    forgotBtn.onclick = () => {
      const dp = localStorage.getItem("devicePin");
      if (!dp) return alert("No device PIN set");
      const dpin = prompt("Enter your DEVICE PIN:");
      if (dpin !== dp) return alert("Wrong device PIN");
      const np = prompt("New 4-digit Account PIN:");
      if (!/^\d{4}$/.test(np)) return alert("Must be 4 digits");
      account.pin = np;
      saveAccount().then(() => alert("Account PIN reset"));
    };

    // Friend management
    addFriendBtn.onclick = async () => {
      const email = rng("friendEmail").value.trim().toLowerCase();
      if (!email || account.friends.includes(email)) return;
      // lookup public
      const snap = await getDocs(query(collection(db, "usersPublic"), where("email", "==", email)));
      if (snap.empty) return alert("No user found");
      account.friends.push(email);
      await saveAccount();
      rng("friendEmail").value = "";
      renderFriends();
    };

    userSearchBtn.onclick = async () => {
      const q = rng("userSearchInput").value.trim().toLowerCase();
      rng("searchResults").innerHTML = "";
      if (!q) return;
      const snap = await getDocs(collection(db, "usersPublic"));
      snap.forEach(doc => {
        const { email, displayName } = doc.data();
        if (email.includes(q) && email !== currentUser.email) {
          const el = linkWith("user", email + " (" + displayName + ")", () => rng("userSearchInput").value = email);
          rng("searchResults").appendChild(el);
        }
      });
    };

    // Render functions
    function renderAll() {
      renderServers(); renderFriends(); renderSharedWithMe();
    }

    function renderServers() {
      rng("serversList").innerHTML = "";
      account.servers.forEach(s => {
        const div = serverCard(s, true);
        rng("serversList").append(div);
      });
    }

    function renderFriends() {
      rng("friendsList").innerHTML = "";
      account.friends.forEach(email => {
        const li = document.createElement("li");
        li.textContent = email + " ";
        const btn = document.createElement("button");
        btn.textContent = "Remove";
        btn.onclick = async () => {
          if (!confirm("Remove friend?")) return;
          account.friends = account.friends.filter(e => e !== email);
          await saveAccount();
          renderFriends();
        };
        li.append(btn);
        rng("friendsList").append(li);
      });
    }

    async function renderSharedWithMe() {
      rng("sharedSection").classList.add("hidden");
      sharedWithMe = [];
      rng("sharedList").innerHTML = "";

      // fetch each friend’s servers
      for (const email of account.friends) {
        const pSnap = await getDocs(query(collection(db, "usersPublic"), where("email", "==", email)));
        if (pSnap.empty) continue;
        const uid = pSnap.docs[0].id;
        const sSnap = await getDoc(doc(db, "users", uid));
        if (!sSnap.exists()) continue;
        sSnap.data().servers.forEach(s => {
          if (s.sharedWith.includes("ALL_FRIENDS") || s.sharedWith.includes(currentUser.uid)) {
            sharedWithMe.push({ ...s, ownerEmail: email });
          }
        });
      }

      if (sharedWithMe.length) {
        rng("sharedSection").classList.remove("hidden");
        sharedWithMe.forEach(s => {
          rng("sharedList").append(serverCard(s, false, true));
        });
      }
    }

    // Card generator
    function serverCard(s, own = false, sharer = false) {
      const div = document.createElement("div");
      div.className = "server-card";
      div.innerHTML = `
        <div>
          <strong>${s.name}</strong><br/>
          <small>${s.link}</small>
          ${s.added ? `<br/><em>Added: ${new Date(s.added).toLocaleString()}</em>` : ""}
          ${sharer ? `<br/><em>Shared by: ${s.ownerEmail}</em>` : ""}
        </div>
      `;
      const actions = document.createElement("div");
      actions.className = "actions";

      const join = btn("▶", () => window.open(s.link, "_blank"));
      actions.append(join);

      if (own) {
        actions.append(btn("✏️", () => editSrv(s)));
        actions.append(btn("🗑️", () => deleteSrv(s)));
        actions.append(btn("🔁", () => shareModal(s)));
      }
      div.append(actions);

      return div;
    }

    function btn(label, fn) {
      const b = document.createElement("button");
      b.textContent = label;
      b.onclick = fn;
      return b;
    }

    // Edit/Delete
    async function editSrv(s) {
      const p = prompt("Account PIN:");
      if (p !== account.pin) return alert("Wrong PIN");
      const link = prompt("Link:", s.link);
      const name = prompt("Name:", s.name);
      if (link && name) {
        s.link = link; s.name = name;
        await saveAccount();
        renderServers();
      }
    }

    async function deleteSrv(s) {
      const p = prompt("Account PIN:");
      if (p !== account.pin) return alert("Wrong PIN");
      account.servers = account.servers.filter(x => x.id !== s.id);
      await saveAccount();
      renderServers();
    }

    // Share modal functionality
    function shareModal(srv) {
      const emails = [...account.friends];
      const selected = new Set(srv.sharedWith);
      const modal = document.getElementById("shareModal");
      const list = modal.querySelector("#shareList");
      const allCb = modal.querySelector("#shareAll");

      list.innerHTML = "";
      emails.forEach(email => {
        const li = document.createElement("li");
        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.value = email;
        if (selected.has(email) || selected.has("ALL_FRIENDS")) cb.checked = true;
        const lbl = document.createElement("label");
        lbl.textContent = email;
        li.append(cb, lbl);
        list.append(li);
      });

      allCb.checked = selected.has("ALL_FRIENDS");

      modal.style.display = "flex";
      modal.querySelector("#saveShare").onclick = async () => {
        const toSave = final => {
          srv.sharedWith = final;
          saveAccount().then(() => {
            renderServers();
            renderSharedWithMe();
            modal.style.display = "none";
          });
        };

        const final = [];
        if (modal.querySelector("#shareAll").checked) final.push("ALL_FRIENDS");
        list.querySelectorAll("input:checked").forEach(cb => final.push(cb.value));

        toSave(final);
      };
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
    body { margin:0; font-family:Roboto,sans-serif; background:#121212; color:#eee; }
    .app-logged-in #login { display:none; }
    .app-logged-in #container { display:flex; flex-direction:column; gap:24px; padding:24px; }
    #login { display:flex; justify-content:center; padding:100px; }
    button { padding:8px 12px; margin:4px; background:#00bcd4; border:none; border-radius:6px; cursor:pointer; color:#000; }
    button:hover, button:focus { background:#0097a7; outline:none; }
    input { width:calc(100% - 20px); padding:10px; margin:4px 0; border-radius:6px; border:none; background:#262626; color:#eee; }
    section { display:flex; flex-direction:column; gap:8px; }
    #serversList, #sharedList, #friendsList, #searchResults { list-style:none; padding:0; }
    .server-card { background:#1e1e1e; padding:12px; border-radius:8px; display:flex; justify-content:space-between; }
    .actions button { margin-left:6px; }
    #shareModal {
      position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8);
      display:none; align-items:center; justify-content:center;
    }
    #shareModal .content {
      background:#272727; padding:20px; border-radius:8px; width:300px;
    }
    #shareModal ul { max-height:180px; overflow-y:auto; padding:0; }
    #shareModal li { list-style:none; margin:4px 0; }
    #shareModal label { margin-left:6px; }
    footer { text-align:center; padding:12px; font-size:12px; color:#555; }
  </style>

  <!-- Share modal -->
  <div id="shareModal">
    <div class="content">
      <h3>Share server with:</h3>
      <label><input type="checkbox" id="shareAll" /> All Friends</label>
      <ul id="shareList"></ul>
      <button id="saveShare">Save</button>
    </div>
  </div>

</body>
</html>
