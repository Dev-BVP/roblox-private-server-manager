<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Server Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
</head>
<body>
  <h1>Private Server Manager</h1>

  <div id="login">
    <button id="signInBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="vertical-align:middle;margin-right:8px">
      Sign in with Google
    </button>
  </div>

  <div id="app" class="hidden">
    <button id="signOutBtn">Sign Out</button><br><br>

    <button id="forgotBtn">Forgot PIN?</button><br><br>

    <input id="serverLink" type="text" placeholder="Private server link" /><br>
    <input id="serverName" type="text" placeholder="Optional server name" /><br>
    <input id="pinInput" type="password" placeholder="4-digit Account PIN" maxlength="4" /><br>
    <button id="addServerBtn">Add/Edit Private Server</button>

    <div id="serversList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDM9zEhD6qnur2RY4zK5ZQ_TbJVkESsnRw",
      authDomain: "roblox-server-manager.firebaseapp.com",
      projectId: "roblox-server-manager",
      storageBucket: "roblox-server-manager.appspot.com",
      messagingSenderId: "223404001099",
      appId: "1:223404001099:web:4eee47729061301c158ace",
      measurementId: "G-G9PV6GD2KN"
    };
    initializeApp(firebaseConfig);

    const auth = getAuth();
    const provider = new GoogleAuthProvider();
    const db = getFirestore();

    provider.setCustomParameters({ prompt: "select_account" });

    const signInBtn = document.getElementById("signInBtn"),
          signOutBtn = document.getElementById("signOutBtn"),
          forgotBtn = document.getElementById("forgotBtn"),
          appDiv = document.getElementById("app"),
          loginDiv = document.getElementById("login"),
          serversList = document.getElementById("serversList"),
          linkInput = document.getElementById("serverLink"),
          nameInput = document.getElementById("serverName"),
          pinInput = document.getElementById("pinInput"),
          addBtn = document.getElementById("addServerBtn");

    let currentUser = null, accountData = { pin: "", servers: [] };

    signInBtn.onclick = async () => {
      try { await signInWithPopup(auth, provider); }
      catch { alert("Sign-in failed."); }
    };

    signOutBtn.onclick = async () => {
      await signOut(auth);
      location.reload();
    };

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        loginDiv.classList.add("hidden");
        appDiv.classList.remove("hidden");
        setupDevicePin();
        await fetchAccount();
        renderServers();
      } else {
        loginDiv.classList.remove("hidden");
        appDiv.classList.add("hidden");
      }
    });

    async function fetchAccount() {
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) accountData = snap.data();
      else await setDoc(ref, accountData);
    }

    async function saveAccount() {
      await setDoc(doc(db, "users", currentUser.uid), accountData);
    }

    function renderServers() {
      serversList.innerHTML = "";
      accountData.servers.forEach((srv, i) => {
        const div = document.createElement("div");
        div.textContent = `${srv.name || srv.link} `;
        const btnE = createBtn("Edit", () => editSrv(i));
        const btnD = createBtn("Del", () => delSrv(i));
        div.append(btnE, btnD);
        serversList.append(div);
      });
    }

    function createBtn(txt, fn) {
      const b = document.createElement("button");
      b.textContent = txt;
      b.onclick = fn;
      return b;
    }

    addBtn.onclick = async () => {
      const link = linkInput.value.trim(), name = nameInput.value.trim(), pin = pinInput.value.trim();
      if (!link || !/^\d{4}$/.test(pin)) return alert("Enter link + 4-digit PIN");
      if (!accountData.pin) accountData.pin = pin;
      if (pin !== accountData.pin) return alert("Incorrect PIN");
      accountData.servers.push({ link, name: name || link });
      await saveAccount();
      renderServers();
      linkInput.value = nameInput.value = pinInput.value = "";
    };

    function setupDevicePin() {
      if (!localStorage.getItem("devicePin")) {
        const d = prompt("Set your 4-digit DEVICE PIN:");
        if (/^\d{4}$/.test(d)) localStorage.setItem("devicePin", d);
        else alert("Device PIN must be 4 digits.");
      }
    }

    forgotBtn.onclick = async () => {
      const dp = localStorage.getItem("devicePin");
      if (!dp) return alert("Set device PIN first.");
      const entered = prompt("Enter your DEVICE PIN:");
      if (entered !== dp) return alert("Incorrect device PIN.");
      const np = prompt("Enter NEW 4-digit Account PIN:");
      if (!/^\d{4}$/.test(np)) return alert("Account PIN must be 4 digits.");
      accountData.pin = np;
      await saveAccount();
      alert("Your account PIN has been reset.");
    };

    async function editSrv(i) {
      const p = prompt("Enter Account PIN:");
      if (p !== accountData.pin) return alert("Incorrect PIN");
      const l = prompt("New link:", accountData.servers[i].link),
            n = prompt("New name:", accountData.servers[i].name);
      if (l && n) { accountData.servers[i] = { link: l, name: n }; await saveAccount(); renderServers(); }
    }

    async function delSrv(i) {
      const p = prompt("Enter Account PIN:");
      if (p !== accountData.pin) return alert("Incorrect PIN");
      accountData.servers.splice(i, 1);
      await saveAccount();
      renderServers();
    }
  </script>

  <style>
    body { background:#121212; color:#eee; font-family:Segoe UI, sans-serif; margin:20px; text-align:center; }
    .hidden{display:none}
    button{margin:6px;padding:8px 12px;border:none;border-radius:6px;background:#00bcd4;color:#000;cursor:pointer}
    button:hover{background:#0097a7}
    #serversList > div{margin:10px;}
  </style>
</body>
</html>
